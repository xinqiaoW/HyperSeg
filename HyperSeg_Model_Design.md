# HyperSeg: 基于SAM的高光谱图像分割模型

---

## 1. 背景介绍

### 1.1 任务定义

高光谱图像分割是一项计算机视觉任务，旨在将高光谱图像中的每个像素分配到特定的语义类别（如植被、水体、建筑、道路等）。与传统RGB图像分割不同，高光谱分割需要处理数十甚至数百个光谱通道的信息。

### 1.2 什么是高光谱图像？

高光谱图像（Hyperspectral Image, HSI）是一种特殊的遥感图像：

| 特性 | RGB图像 | 高光谱图像 |
|------|---------|------------|
| 通道数 | 3 (R, G, B) | 数十到数百 (如204个波段) |
| 波长范围 | 可见光 (400-700nm) | 可见光+近红外+短波红外 (400-2500nm) |
| 光谱分辨率 | 低 | 高（连续光谱采样） |
| 信息量 | 颜色信息 | 物质光谱特征 |

### 1.3 分割任务示例

```
输入: 高光谱图像 (H × W × D)，D为光谱通道数
      例如: 512 × 512 × 204

输出: 分割掩码 (H × W)
      每个像素对应一个类别标签

类别示例:
  0: 背景
  1: 植被
  2: 水体
  3: 建筑
  4: 道路
  ...
```

---

## 2. 研究动机

### 2.1 现有方法的问题

#### 问题一：未充分利用预训练模型

```
现有方法的做法:
┌─────────────────────────────────────────────┐
│  高光谱图像 → 从头训练的网络 → 分割结果      │
│                    ↑                         │
│              随机初始化权重                   │
│              需要大量标注数据                 │
│              训练成本高                       │
└─────────────────────────────────────────────┘

问题:
• SAM等基础模型拥有强大的分割先验知识
• 从头训练浪费了这些宝贵的预训练权重
• 高光谱数据集标注成本高，数据量有限
• 模型泛化能力受限
```

#### 问题二：数据集质量问题

```
现有数据集构建方式:
┌─────────────────────────────────────────────┐
│  原始图像 → SAM自动分割 → 作为GT标签训练     │
│                  ↑                           │
│            标签质量不可靠                     │
│            包含SAM的分割错误                  │
│            噪声标签影响模型学习               │
└─────────────────────────────────────────────┘
```

### 2.2 我们的改进

#### 改进一：旁支结构设计

```
我们的方法:
┌────────────────────────────────────────────────────────────┐
│                                                            │
│  高光谱图像 ──→ 轻量级光谱编码器 ──┐                        │
│                    (可训练)        │                        │
│                                    ├──→ 特征融合 → 分割结果 │
│  RGB转换图像 ──→ SAM编码器 ────────┘                        │
│                 (冻结权重)                                  │
│                                                            │
└────────────────────────────────────────────────────────────┘

优势:
✓ 复用SAM的预训练权重和分割先验
✓ 只训练旁支网络，显存占用小
✓ 收敛速度快，训练效率高
✓ 泛化能力强
```

#### 改进二：多模型标签筛选

```
数据集构建流程:
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  原始图像 ──┬──→ SAM分割结果 ────┐                          │
│            │                     │                          │
│            ├──→ 模型B分割结果 ───┼──→ 一致性筛选 → 高质量GT │
│            │                     │                          │
│            └──→ 模型C分割结果 ───┘                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘

优势:
✓ 多模型投票提高标签可靠性
✓ 过滤掉单一模型的分割错误
✓ 保留高置信度的分割区域
```

---

## 3. 模型架构

### 3.1 整体架构图

```
                            HyperSeg 模型架构
┌──────────────────────────────────────────────────────────────────────┐
│                                                                      │
│  ┌─────────────┐                                                     │
│  │ 高光谱图像   │                                                     │
│  │ (B,D,H,W)   │                                                     │
│  └──────┬──────┘                                                     │
│         │                                                            │
│         ▼                                                            │
│  ┌─────────────────┐      ┌─────────────────┐                        │
│  │  Spectral       │      │  RGB Encoder    │◄── SAM预训练权重(冻结) │
│  │  Encoder        │      │  (ViT-H)        │                        │
│  │  (可训练)       │      └────────┬────────┘                        │
│  └────────┬────────┘               │                                 │
│           │                        │                                 │
│           ▼                        ▼                                 │
│  ┌─────────────────┐      ┌─────────────────┐                        │
│  │ Spatial         │      │ RGB             │                        │
│  │ Embeddings      │      │ Embeddings      │                        │
│  │ (B,C,h,w)       │      │ (B,C,h,w)       │                        │
│  └────────┬────────┘      └────────┬────────┘                        │
│           │                        │                                 │
│           └──────────┬─────────────┘                                 │
│                      ▼                                               │
│           ┌─────────────────────┐                                    │
│           │   HSI-RGB Fusion    │◄── 新增模块                        │
│           │   (ResConv融合)     │                                    │
│           └──────────┬──────────┘                                    │
│                      │                                               │
│                      ▼                                               │
│           ┌─────────────────────┐                                    │
│           │   Fused Embeddings  │                                    │
│           │   (B,C,h,w)         │                                    │
│           └──────────┬──────────┘                                    │
│                      │                                               │
│                      ▼                                               │
│           ┌─────────────────────┐                                    │
│           │   Mask Decoder HQ   │◄── SAM预训练权重                   │
│           └──────────┬──────────┘                                    │
│                      │                                               │
│                      ▼                                               │
│           ┌─────────────────────┐                                    │
│           │   Segmentation Mask │                                    │
│           │   (B,1,H,W)         │                                    │
│           └─────────────────────┘                                    │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

### 3.2 核心模块详解

#### 3.2.1 Channel Projection (光谱通道投影)

**设计意图**: 将任意数量的光谱通道映射到固定维度的特征空间，使模型能处理不同波段配置的高光谱数据。

```
输入: x (B*N, D)          - 光谱特征，D为通道数
      wavelengths (D,)    - 波长信息

处理流程:
┌────────────────────────────────────────────────────────────┐
│                                                            │
│  wavelengths (D,)                                          │
│       │                                                    │
│       ▼                                                    │
│  ┌──────────────────┐                                      │
│  │ Positional       │  正弦余弦位置编码                     │
│  │ Encoding         │  编码波长的物理位置信息               │
│  └────────┬─────────┘                                      │
│           │ (D, E)                                         │
│           ▼                                                │
│  ┌──────────────────┐                                      │
│  │ Two-layer MLP    │  学习波长特征变换                     │
│  └────────┬─────────┘                                      │
│           │ (D, E)                                         │
│           ▼                                                │
│  ┌──────────────────┐                                      │
│  │ Transformer      │  建模波段间的相互关系                 │
│  │ Encoder Layer    │  自注意力捕获光谱相关性               │
│  └────────┬─────────┘                                      │
│           │ (D, E)                                         │
│           ▼                                                │
│  ┌──────────────────┐                                      │
│  │ Final MLP        │  生成投影权重矩阵                     │
│  └────────┬─────────┘                                      │
│           │ (D, E) = projection_weights                    │
│           │                                                │
│           ▼                                                │
│  output = x @ projection_weights                           │
│  (B*N, D) @ (D, E) → (B*N, E)                              │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

**设计亮点**:
- **位置编码**: 利用波长的连续性，相近波长获得相似编码
- **Transformer**: 捕获不同波段间的光谱相关性（如水体在特定波段的吸收特征）
- **动态投影**: 投影矩阵由波长信息动态生成，适应不同传感器配置

#### 3.2.2 HSI-RGB Fusion (高光谱-RGB特征融合)

**设计意图**: 将SAM的RGB特征与高光谱空间特征进行有效融合，结合两者优势。

```
架构设计:
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  RGB Embeddings          Spatial Embeddings                 │
│  (B, C, h, w)            (B, C, h, w)                       │
│       │                        │                            │
│       ▼                        ▼                            │
│  ┌──────────┐            ┌──────────┐                       │
│  │ ResConv  │            │ ResConv  │                       │
│  │ C → C/2  │            │ C → C/2  │                       │
│  └────┬─────┘            └────┬─────┘                       │
│       │                        │                            │
│       │  (B, C/2, h, w)       │  (B, C/2, h, w)            │
│       │                        │                            │
│       └──────────┬─────────────┘                            │
│                  │ Concat                                   │
│                  ▼                                          │
│           (B, C, h, w)                                      │
│                  │                                          │
│                  ▼                                          │
│           ┌──────────┐                                      │
│           │ ResConv  │                                      │
│           │ C → C    │                                      │
│           └────┬─────┘                                      │
│                │                                            │
│                ▼                                            │
│         Fused Embeddings                                    │
│         (B, C, h, w)                                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘

ResConv Block (残差卷积块):
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  Input ──┬──→ Conv3×3 → LayerNorm → ReLU → Conv3×3 → LN ──┐ │
│          │                                                │ │
│          └────────────→ Shortcut (1×1 Conv if needed) ────┘ │
│                                    │                        │
│                                    ▼                        │
│                                  + Add                      │
│                                    │                        │
│                                    ▼                        │
│                                  ReLU                       │
│                                    │                        │
│                                    ▼                        │
│                                 Output                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**设计亮点**:
- **残差连接**: 保证梯度流动，训练更稳定
- **LayerNorm**: 对高光谱数据的batch大小变化更鲁棒
- **通道压缩后融合**: 先压缩到C/2，concat后恢复C，参数高效
- **双流并行处理**: RGB和HSI特征分别提取后融合

---

## 4. 模型主要模块

| 模块名称 | 功能 | 是否可训练 | 参数来源 |
|---------|------|-----------|---------|
| `rgb_encoder` | RGB图像编码 | 冻结 | SAM预训练 |
| `spectral_encoder` | 高光谱编码 | 可训练 | 随机初始化 |
| `channel_proj` | 光谱通道投影 | 可训练 | 随机初始化 |
| `hsi_rgb_fusion` | HSI-RGB融合 | 可训练 | 随机初始化 |
| `prompt_encoder` | 提示编码 | 冻结 | SAM预训练 |
| `mask_decoder` | 掩码解码 | 部分微调 | SAM预训练 |
| `feature_fusion` | 特征融合 | 可训练 | 随机初始化 |

---

## 5. 设计优势总结

### 5.1 显存效率

```
传统方法:
  整个网络从头训练 → 所有参数需要梯度 → 显存占用大

我们的方法:
  SAM骨干网络冻结 → 只需存储旁支网络梯度 → 显存节省约60%
```

### 5.2 训练效率

```
传统方法:
  大量参数需要收敛 → 训练周期长

我们的方法:
  利用SAM先验知识 → 只训练轻量旁支 → 收敛速度提升3-5倍
```

### 5.3 泛化能力

```
传统方法:
  在有限高光谱数据上训练 → 泛化能力受限

我们的方法:
  SAM在海量数据预训练 → 强大的通用分割先验 → 泛化能力更强
```

---

## 6. 前向传播流程

```python
def forward(batched_input, wavelengths, multimask_output):
    # 1. RGB编码 (SAM预训练，冻结)
    image_embeddings_rgb = self.rgb_encoder(input_images_rgb)

    # 2. 高光谱编码 (可训练)
    spatial_embeddings = self.spectral_encoder(input_images_hsi)

    # 3. HSI-RGB特征融合 (新增)
    image_embeddings_rgb = self.hsi_rgb_fusion(
        image_embeddings_rgb,   # SAM的RGB特征
        spatial_embeddings      # 高光谱空间特征
    )

    # 4. 光谱查询融合
    queries, fused_embeddings = self.feature_fusion.fuse_features(
        queries, spatial_embeddings
    )

    # 5. 掩码解码
    masks = self.mask_decoder(
        image_embeddings_rgb,
        prompt_embeddings
    )

    return masks
```
